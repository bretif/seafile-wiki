In a production environment, you often want to deploy Seafile Web(Seahub) behind a reverse proxy like Apache or nginx. Use a web server serves multiple purposes:

* Static files can be served by Apache/Nginx directly to achieve better performance.
* You need to use Apache/Nginx if you want to [[Enable Https on Seafie Web]].

Before continue, ensure that:

* you have installed the <code>python-flup</code> library
* you have '''NOT''' started seafile or seahub

= Deploy with nginx =

== Deploy in the root domain ==

Assume you are running seahub as the root domain, for example '''www.myseafile.com'''

This is a sample nginx config file.

<pre>
server {
    listen 80;
    server_name www.myseafile.com;
    location / {
        fastcgi_pass    127.0.0.1:8000;
        fastcgi_param   SCRIPT_FILENAME     $document_root$fastcgi_script_name;
        fastcgi_param   PATH_INFO           $fastcgi_script_name;

        fastcgi_param	SERVER_PROTOCOL		$server_protocol;
        fastcgi_param   QUERY_STRING        $query_string;
        fastcgi_param   REQUEST_METHOD      $request_method;
        fastcgi_param   CONTENT_TYPE        $content_type;
        fastcgi_param   CONTENT_LENGTH      $content_length;
        fastcgi_param	SERVER_ADDR         $server_addr;
        fastcgi_param	SERVER_PORT         $server_port;
        fastcgi_param	SERVER_NAME         $server_name;

        access_log      /var/log/nginx/seahub.access.log;
    	error_log       /var/log/nginx/seahub.error.log;
    }       

    location /media {
        root /path/to/seahub;
    }
}
</pre>

== Deploy in a non-root domain ==

Assume your want to deploy seahub to '''www.mycompany.com/seafile'''. First you need to modify the settings file:

* If you're using the pre-compiled server package, the file is <code><top seafile server dir>/seahub_settings.py</code>
* If you build seafile server from source, the file need to be created yourself as <code>/path/to/seahub/local_settings.py</code>

Add these two lines to that file:
<pre>
SITE_ROOT = '/seafile/' 
MEDIA_URL = '/seafile/media/'
</pre>

'''SITE_ROOT''' is the suffix of the domain domain you assign to seahub, and '''MEDIA_URL''' should be SITE_ROOT plus the '''media/''' suffix. All the two must end with a trailing slash.

The nginx config also need some modification:
<pre>
server {
    listen 80;
    server_name www.myseafile.com;
    location /seafile {
        fastcgi_pass    127.0.0.1:8000;
        fastcgi_param   SCRIPT_FILENAME     $document_root$fastcgi_script_name;
        fastcgi_param   PATH_INFO           $fastcgi_script_name;

        fastcgi_param	SERVER_PROTOCOL		$server_protocol;
        fastcgi_param   QUERY_STRING        $query_string;
        fastcgi_param   REQUEST_METHOD      $request_method;
        fastcgi_param   CONTENT_TYPE        $content_type;
        fastcgi_param   CONTENT_LENGTH      $content_length;
        fastcgi_param	SERVER_ADDR         $server_addr;
        fastcgi_param	SERVER_PORT         $server_port;
        fastcgi_param	SERVER_NAME         $server_name;

        access_log      /var/log/nginx/seahub.access.log;
    	error_log       /var/log/nginx/seahub.error.log;
    }       

    location /seafile/media {
        rewrite ^/seafile/media(.*)$ /media$1 break;
        root /path/to/seahub/;
    }
}
</pre>

= Deploy With Apache =

== Setup Apache ==

You need to configure Apache first, install and enable mod_fastcgi. 

Then edit httpd.conf file, add this line:

  FastCGIExternalServer /var/www/seahub.fcgi -host 127.0.0.1:8000

== Deploy in the root domain ==

Assume you are running seahub as the root domain, for example '''www.myseafile.com'''

This is a sample apache config file.

<pre>
<VirtualHost *:80>
  ServerName www.example.com
  DocumentRoot /var/www
  Alias /media  /home/user/haiwen/seafile-server-1.3.2/seahub/media         # path to your seahub media 
  RewriteEngine On
  RewriteRule ^/(media.*)$ /$1 [QSA,L,PT]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteRule ^/(.*)$ /seahub.fcgi/$1 [QSA,L]
</VirtualHost>
</pre>

== Deploy in a non-root domain ==

'''todo'''

= Start Seahub =

Before you start seafile and seahub, you first need to modify the file <code>ccnet.conf</code>.

== Modify ccnet.conf ==

Modify the value of <code>SERVICE_URL</code> in <code>/data/haiwen/ccnet/ccnet.conf</code>

<pre>
SERVICE_URL = www.myseafile.com
</pre>

If you later change the domain assigned to seahub, you also need to change the value of  <code>SERVICE_URL</code>. 

Now you can start seafile server, and then, start seahub with as following.

== When use the pre-compiled server package ==

Assume you have followed the steps in [[Download and Setup Seafile Server]]. 

<pre>
seafile_prefix=/data/haiwen/seafile-server-1.3.0 # your seafile server directory
export PYTHONPATH=${seafile_prefix}/seafile/lib/python2.6/site-packages:${seafile_prefix}/seafile/lib64/python2.6/site-packages:${seafile_prefix}/seafile/lib/python2.7/site-packages:${seafile_prefix}/seahub/thirdpart:$PYTHONPATH
export LD_LIBRARY_PATH=${seafile_prefix}/seafile/lib/:${seafile_prefix}/seafile/lib64:${LD_LIBRARY_PATH}
export CCNET_CONF_DIR=/data/haiwen/ccnet # directory store your ccnet.conf

cd ${seafile_prefix}/seahub
python ./manage.py runfcgi host=127.0.0.1 port=8000 errlog=/tmp/seahub-stderr.log outlog=/tmp/seahub-stdout.log
</pre>

== When build seafile server from source ==

Assume you have followed the steps of [[Build and Deploy Seafile Server from source]], and you have uncompressed seahub to <code>/data/haiwen/seahub/</code>

<pre>
export CCNET_CONF_DIR=/path/to/your/ccnet/conf/dir
export PYTHONPATH=/data/haiwen/seahub/thirdpart:$PYTHONPATH

cd /data/haiwen/seahub
python ./manage.py runfcgi host=127.0.0.1 port=8000 \
 errlog=/tmp/seahub-stderr.log outlog=/tmp/seahub-stdout.log
</pre>